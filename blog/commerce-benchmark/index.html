<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="darkreader" content="NO-DARKREADER-PLUGIN" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Benchmarking relational data in BonsaiDb</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/monokai.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script>
    <script src="/nodarkreader.min.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/bonsaidb-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/bonsaidb-16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="alternate" type="application/atom+xml" title="The BonsaiDb Blog" href="/blog/atom.xml" />
</head>

<body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/">
                <img src="/bonsaidb-64.png" height="28" />
                <h1>BonsaiDb</h1>
            </a>
            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbar-menu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>

        <div class="navbar-menu" id="navbar-menu">
            <div class="navbar-start">
                <a class="navbar-item 



" href="/">
                    Getting Started
                </a>
                <a class="navbar-item 



" href="/about/">
                    What is BonsaiDb?
                </a>
                <a class="navbar-item 


is-active
" href="/blog/">
                    Blog
                </a>
            </div>
            <div class="navbar-end">
                <a class="navbar-item" href="https://dev.bonsaidb.io/guide/">
                    <i class="font-icon bi-book"></i> User's Guide</a>
                <a class="navbar-item" href="https://dev.bonsaidb.io/main/bonsaidb">
                    <i class="font-icon bi-journal-code"></i>
                    Documentation</a>
                <a class="navbar-item" href="https://community.khonsulabs.com/c/open-source/bonsaidb/18">
                    <i class="font-icon bi-chat"></i>
                    Forums</a>
                <a class="navbar-item" href="https://discord.khonsulabs.com">
                    <i class="font-icon bi-discord"></i>
                    Discord</a>
                <a class="navbar-item" href="https://github.com/khonsulabs/bonsaidb">
                    <i class="font-icon bi-github"></i> Source
                    Code</a>
            </div>
        </div>
    </nav>

    
<div class="container content px-4">
    <h1>Benchmarking relational data in BonsaiDb</h1>
    
    <p>
        
        Written by <a href="https:&#x2F;&#x2F;github.com&#x2F;ecton">Ecton</a>.
        
        
        Published 2022-01-18.
        
        
    </p>
    
    <blockquote>
<p>If you aren't familiar with BonsaiDb, check out our <a href="/about/">What is BonsaiDb?</a> page.</p>
</blockquote>
<p>While we're working towards our first alpha, I've been trying to anticipate
questions potential users might have when looking at BonsaiDb for the first
time. While we are keeping the alpha label, we are hoping to find some
adventurous users who are excited at our vision of a database designed for and
written in Rust.</p>
<p>One obvious question that almost everyone will ask at some point when hearing
about a new database: <strong>how does it perform?</strong></p>
<p>BonsaiDb is a unique database. It is best described as a <a href="https://en.wikipedia.org/wiki/NoSQL">NoSQL</a>
database, but traditionally NoSQL databases tend to favor eventual consistency
and speed over ACID compliance. When starting this project, I specifically
wanted to have all the guarantees PostgreSQL makes, but easier to use and deploy.</p>
<p>Until this past week, I knew from previous benchmarks that <a href="https://github.com/khonsulabs/nebari">Nebari</a> (our
underlying storage layer) was <a href="https://github.com/khonsulabs/nebari/tree/192b6d34c6ad1350c2e469359f51423f69b1e2d4/benchmarks">pretty fast</a>, but I had no real
indicator of how BonsaiDb would perform relative to PostgreSQL.</p>
<h2 id="designing-a-benchmark-suite">Designing a Benchmark Suite</h2>
<p>I had three different parameters I wanted to measure:</p>
<ul>
<li>Dataset size</li>
<li>The amount of concurrent workers</li>
<li>Read-heavy vs Write-heavy workloads</li>
</ul>
<p>I decided to create a benchmark suite inspired by the needs of an ecommerce
website. The basic idea is to generate an initial data set, a list of plans for
workers to execute, and test the dataset and plans using different quantities of
workers. The operations being benchmarked are:</p>
<ul>
<li>Lookup product by id</li>
<li>Find product by name (exact match)</li>
<li>Create shopping cart</li>
<li>Add product to cart</li>
<li>Checkout</li>
<li>Review a product</li>
</ul>
<p>A single plan is generated by using probabilities to adjust how many plans
succeed in each step of the shopping process. Some plans will search for
products and never add them to a cart; Others will not only purchase the
product, but also write a review. By adjusting the probabilities of each action
occurring, we create a funnel that allows us to adjust the ratio of reads and
writes.</p>
<p>I've written some more notes on the implementation of the benchmark itself, such
as how aggregation of ratings is handled, in the <a href="https://github.com/khonsulabs/bonsaidb/tree/73aa1b1e8086c23bee10cd3024bf5fcaff8ea13e/benchmarks/benches/commerce#user-content-benchmark-notes">benchmark's
README</a>.</p>
<h2 id="bonsaidb-is-faster-than-i-had-hoped">BonsaiDb is faster than I had hoped!</h2>
<p>Let's take a look at the &quot;find product by name&quot; operation's results. These graphs show a histogram where each time FindProduct is executed is plotted based on how long it took.</p>
<p><a href="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/large-writeheavy/4/index.html#bonsaidb-local-FindProduct"><img src="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/large-writeheavy/4/bonsaidb-local-FindProduct.png" alt="bonsaidb-local find product by name" /></a>
<a href="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/large-writeheavy/4/index.html#bonsaidb-quic-FindProduct"><img src="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/large-writeheavy/4/bonsaidb-quic-FindProduct.png" alt="bonsaidb-quic find product by name" /></a>
<a href="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/large-writeheavy/4/index.html#bonsaidb-ws-FindProduct"><img src="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/large-writeheavy/4/bonsaidb-ws-FindProduct.png" alt="bonsaidb-websockets find product by name" /></a>
<a href="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/large-writeheavy/4/index.html#postgresql-FindProduct"><img src="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/large-writeheavy/4/postgresql-FindProduct.png" alt="postgresql find product by name" /></a></p>
<p>These graphs show that BonsaiDb averages FindProduct in less than
1ms while PostgreSQL regularly has response times while PostgreSQL has no
response times less than 1.6ms.</p>
<p>This set of graphs is from the &quot;large, write-heavy, 2 workers per core&quot;
benchmark, run on a <a href="https://scaleway.com">Scaleway</a> GP1-XS instance
running Ubuntu 20.04 with 4 CPU cores, 16GB of RAM, and local NVME storage. The
entire suite's results can be <a href="https://khonsulabs-storage.s3.us-west-000.backblazeb2.com/bonsaidb-scaleway-gp1-xs/commerce/index.html">viewed here</a> as well. To summarize,
if you sum the total wall time of BonsaiDb via WebSockets and the PosgreSQL
version, you'll see that BonsaiDb took 2 minutes and 36 seconds to complete, and
PostgreSQL took 24 minutes and 48 seconds, ranging between 46% and 94% faster.</p>
<p>As I started seeing these results, I was simply blown away. I've tried to be <a href="https://github.com/khonsulabs/bonsaidb/tree/73aa1b1e8086c23bee10cd3024bf5fcaff8ea13e/benchmarks/benches/commerce#user-content-benchmark-notes">as
fair as possible</a> in writing this benchmark suite. Over time I
plan on adding additional database backends for comparison, as well as
additional operations as BonsaiDb gains more features.</p>
<p>One major difference between PostgreSQL and BonsaiDb is the lack of SQL. With
BonsaiDb, the query language is Rust itself. This is why I often refer to
BonsaiDb as a <em>programmable database</em>. The interface for accessing your data is
how <a href="https://dev.bonsaidb.io/guide/about/concepts/view.html">you design it</a>. For example, here's the implementation of find product:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> product = Product::load(&amp;operation.name, &amp;</span><span style="color:#bf616a;">self</span><span>.database)
</span><span>    .await
</span><span>    .</span><span style="color:#96b5b4;">unwrap</span><span>() </span><span style="color:#65737e;">// Result
</span><span>    .</span><span style="color:#96b5b4;">unwrap</span><span>(); </span><span style="color:#65737e;">// Option&lt;CollectionDocument&lt;Product&gt;&gt;
</span><span style="color:#b48ead;">let</span><span> rating = </span><span style="color:#bf616a;">self
</span><span>    .database
</span><span>    .view::&lt;ProductReviewsByProduct&gt;()
</span><span>    .</span><span style="color:#96b5b4;">with_key</span><span>(product.id as </span><span style="color:#b48ead;">u32</span><span>)
</span><span>    .</span><span style="color:#96b5b4;">with_access_policy</span><span>(AccessPolicy::NoUpdate)
</span><span>    .</span><span style="color:#96b5b4;">reduce</span><span>()
</span><span>    .await
</span><span>    .</span><span style="color:#96b5b4;">unwrap</span><span>();
</span></code></pre>
<h2 id="trying-out-bonsaidb">Trying out BonsaiDb</h2>
<p><a href="https://github.com/khonsulabs/bonsaidb">BonsaiDb</a> is currently labeled experimental. We are working to stabilize
<a href="https://github.com/khonsulabs/custodian">custodian-password</a>, which has involved updating many existing
crates to improve the <a href="https://github.com/novifinancial/opaque-ke">OPAQUE-KE</a>
ecosystem in Rust. After that is done, we are going to label BonsaiDb as alpha.
It hasn't been used by many people yet, so we expect that there will be bugs and
some of those bugs might even cause loss of data. That being said, we've been
using it ourselves with <a href="https://khonsulabs.com/">KhonsuLabs.com</a> since early
November 2021 with no issues, in addition to a couple other small test projects.</p>
<p>We encourage most users to wait another week or two until we have the alpha on
Crates.io, but for those looking to play with something new, we'd love any
feedback from early users. We've already made countless improvements to the API,
<a href="https://dev.bonsaidb.io/main/bonsaidb/">documentation</a>, <a href="https://dev.bonsaidb.io/guide/">user's guide</a> and
<a href="https://github.com/khonsulabs/bonsaidb/tree/73aa1b1e8086c23bee10cd3024bf5fcaff8ea13e/examples">examples</a> as a result of questions from early adopters.</p>
<p>If you're interested in BonsaiDb but want to wait until we've released a stable
version, we invite you to subscribe to <a href="/blog/atom.xml">this site's feed</a> or
watch the <a href="https://github.com/khonsulabs/bonsaidb/releases">repository's releases section</a>.</p>
<p>We are looking forward to seeing what types of applications BonsaiDb will power someday!</p>

</div>


    <footer class="footer">
        <div class="content has-text-centered">
            <p>
                <strong>BonsaiDb</strong> by <a href="https://khonsulabs.com">Khonsu Labs</a>. The <a
                    href="https://github.com/khonsulabs/bonsaidb">source code</a> is
                dual-licensed with
                <a href="https://github.com/khonsulabs/bonsaidb/blob/main/LICENSE-MIT">MIT</a> and <a
                    href="https://github.com/khonsulabs/bonsaidb/blob/main/LICENSE-APACHE">Apache License 2.0</a>. The
                website content
                is licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.
            </p>
        </div>
    </footer>

    <script src="/site.js"></script>
</body>

</html>