<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="darkreader" content="NO-DARKREADER-PLUGIN" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BonsaiDb v0.3.0: Optimized views, bug fixes, and more</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/monokai.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script>
    <script src="/nodarkreader.min.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/bonsaidb-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/bonsaidb-16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="alternate" type="application/atom+xml" title="The BonsaiDb Blog" href="/blog/atom.xml" />
    <meta property="og:title"
        content="BonsaiDb v0.3.0: Optimized views, bug fixes, and more" />
    <meta property="og:image"
        content="https://bonsaidb.io/apple-touch-icon.png" />
    <meta property="og:description"
        content="BonsaiDb is a
batteries-included
database
aimed at being the most developer-friendly database." />
    <meta property="og:url" content="https://bonsaidb.io/blog/bonsaidb-v0-3-0/" />
    <meta property="og:image:width" content="180" />
    <meta property="og:image:height" content="180" />
    <meta property="og:type" content='article' />
</head>

<body>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="/">
                <img src="/bonsaidb-64.png" height="28" />
                <h1>BonsaiDb</h1>
            </a>
            <div class="is-hidden-mobile is-flex-tablet">
                <a class="navbar-item 



" href="/">
                    Getting Started
                </a>
                <a class="navbar-item 



" href="/about/">
                    What is BonsaiDb?
                </a>
                <a class="navbar-item 


is-active
" href="/blog/">
                    Blog
                </a>
            </div>
            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbar-menu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>

        <div class="navbar-menu" id="navbar-menu">
            <div class="navbar-start is-hidden-tablet is-flex-mobile">
                <div class="">
                    <a class="navbar-item 



" href="/">
                        Getting Started
                    </a>
                    <a class="navbar-item 



" href="/about/">
                        What is BonsaiDb?
                    </a>
                    <a class="navbar-item 


is-active
" href="/blog/">
                        Blog
                    </a>
                </div>
            </div>
            <div class="navbar-end">
                <a class="navbar-item" href="https://dev.bonsaidb.io/release/guide/">
                    <i class="font-icon bi-book"></i> User's Guide</a>
                <a class="navbar-item" href="https://dev.bonsaidb.io/release/docs/bonsaidb">
                    <i class="font-icon bi-journal-code"></i>
                    Documentation</a>
                <a class="navbar-item" href="https://community.khonsulabs.com/c/open-source/bonsaidb/18">
                    <i class="font-icon bi-chat"></i>
                    Forums</a>
                <a class="navbar-item" href="https://discord.khonsulabs.com">
                    <i class="font-icon bi-discord"></i>
                    Discord</a>
                <a class="navbar-item" href="https://github.com/khonsulabs/bonsaidb">
                    <i class="font-icon bi-github"></i> Source
                    Code</a>
            </div>
        </div>
    </nav>

    
<div class="container content px-4">
    <h1>BonsaiDb v0.3.0: Optimized views, bug fixes, and more</h1>
    
    <p>
        
        Written by <a href="https:&#x2F;&#x2F;github.com&#x2F;ecton">Jonathan Johnson</a>.
        
        
        Published 2022-03-03.
        
        
    </p>
    
    <blockquote>
<p><strong>What is BonsaiDb?</strong></p>
<p><a href="https://github.com/khonsulabs/bonsaidb">BonsaiDb</a> is a new database aiming to be the most developer-friendly
Rust database. BonsaiDb has a unique feature set geared at solving many common
data problems. We have a page dedicated to answering the question: <a href="https://bonsaidb.io/about">What is
BonsaiDb?</a>.</p>
</blockquote>
<p>BonsaiDb <a href="https://github.com/khonsulabs/bonsaidb/releases/tag/v0.3.0">v0.3.0</a> has been released featuring optimized view
processing, bug fixes, and a few new features -- including one from a new
contributor!</p>
<p>Optimization of the view processing system has been covered in the <a href="/blog/february-2022-update#Optimizing%20View%20Mapping">previous
blog post</a>.</p>
<h2 id="">


<a href="#Deleting%20users%20via%20StorageConnection" name="Deleting%20users%20via%20StorageConnection">
    Deleting users via StorageConnection
    <i class="bi bi-link-45deg hoverable"></i>
</a></h2>
<p>A new function, <code>delete_user()</code> has been added to <code>StorageConnection</code>, allowing
for users to not only be created but also deleted without direct database
access. This feature was added by <a href="https://github.com/vbmade2000">@vbmade2000</a> -- now the third
contributor to the BonsaiDb repository!</p>
<p>BonsaiDb provides open-access its <a href="https://docs.rs/bonsaidb/latest/bonsaidb/core/admin/index.html">admin schema types</a>. This meant
that users could still be deleted, but it required doing so directly through
<code>Storage::admin()</code>, and couldn't be done over a networked client, for example.</p>
<h2 id="-1">


<a href="#Querying%20Data%20by%20Prefix" name="Querying%20Data%20by%20Prefix">
    Querying Data by Prefix
    <i class="bi bi-link-45deg hoverable"></i>
</a></h2>
<p>A user on Discord requested an easier way to be able to query data using a
prefix. For example, if the key type is a <code>String</code> or <code>Vec&lt;u8&gt;</code>, a query should
be able to be made for any matches that start with a given prefix. Collections
now support listing documents with a given prefix:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">derive</span><span>(Debug, Serialize, Deserialize, Default, Collection)]
</span><span>#[</span><span style="color:#bf616a;">collection</span><span>(name = &quot;</span><span style="color:#a3be8c;">MyCollection</span><span>&quot;, primary_key = String)]
</span><span style="color:#b48ead;">pub struct </span><span>MyCollection;
</span><span>
</span><span style="color:#b48ead;">let</span><span> results = MyCollection::list_with_prefix(String::from(&quot;</span><span style="color:#a3be8c;">a</span><span>&quot;), db).await?;
</span></code></pre>
<p><code>results</code> will contain all documents whose id's start with <code>a</code>. The same
capability is also available for views:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">derive</span><span>(View, Debug, Clone)]
</span><span>#[</span><span style="color:#bf616a;">view</span><span>(name = &quot;</span><span style="color:#a3be8c;">by-name</span><span>&quot;, key = String, collection = MyCollection)]
</span><span style="color:#b48ead;">struct </span><span>ByName;
</span><span>
</span><span style="color:#b48ead;">for</span><span> mapping in db
</span><span>    .view::&lt;ByName&gt;()
</span><span>    .</span><span style="color:#96b5b4;">with_key_prefix</span><span>(String::from(&quot;</span><span style="color:#a3be8c;">a</span><span>&quot;))
</span><span>    .</span><span style="color:#96b5b4;">query</span><span>()
</span><span>    .await?
</span><span>{
</span><span>    assert!(mapping.key.</span><span style="color:#96b5b4;">starts_with</span><span>(&quot;</span><span style="color:#a3be8c;">a</span><span>&quot;));
</span><span>    println!(&quot;</span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;"> in document </span><span style="color:#d08770;">{:?}</span><span>&quot;, mapping.key, mapping.source);
</span><span>}
</span></code></pre>
<p>This functionality is powered by a new trait,
<a href="https://dev.bonsaidb.io/release/docs/bonsaidb/core/key/trait.IntoPrefixRange.html"><code>IntoPrefixRange</code></a>,
which allows any custom key type to provide this functionality if possible.
BonsaiDb currently only provides implementations for <code>String</code> and the <code>Vec&lt;u8&gt;</code>
types.</p>
<h2 id="-2">


<a href="#Nebari%20Bug%20Fixes" name="Nebari%20Bug%20Fixes">
    Nebari Bug Fixes
    <i class="bi bi-link-45deg hoverable"></i>
</a></h2>
<p>This release updates <a href="https://github.com/khonsulabs/nebari">Nebari</a> to <a href="https://github.com/khonsulabs/nebari/releases/tag/v0.4.0">v0.4.0</a>. It contains
an important fix to ensure the transaction log is always written sequentially.
This edge case was discovered while running unit tests &quot;one more time&quot; before
preparing a release. A unit test that never failed suddenly failed. Here's the
code in question that failed:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let mut</span><span> handles = Vec::new();
</span><span style="color:#b48ead;">for </span><span>_ in </span><span style="color:#d08770;">0</span><span>..</span><span style="color:#d08770;">10 </span><span>{
</span><span>    </span><span style="color:#b48ead;">let</span><span> manager = manager.</span><span style="color:#96b5b4;">clone</span><span>();
</span><span>    handles.</span><span style="color:#96b5b4;">push</span><span>(std::thread::spawn(</span><span style="color:#b48ead;">move </span><span>|| {
</span><span>        </span><span style="color:#b48ead;">for</span><span> id in </span><span style="color:#d08770;">0_</span><span style="color:#b48ead;">u32</span><span>..</span><span style="color:#d08770;">1_000 </span><span>{
</span><span>            </span><span style="color:#b48ead;">let</span><span> tx = manager.</span><span style="color:#96b5b4;">new_transaction</span><span>([&amp;id.</span><span style="color:#96b5b4;">to_be_bytes</span><span>()[..]]);
</span><span>            tx.</span><span style="color:#96b5b4;">commit</span><span>().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>        }
</span><span>    }));
</span><span>}
</span></code></pre>
<p>The test then proceeds to wait for all the threads to finish and verify the
results. One thing it does is attempt to load each transaction one by one. At
first glance, this seems innocuous, but due to how Nebari is designed,
<code>new_transaction()</code> allocates a transaction id, but it isn't written to the
transaction log until <code>commit()</code> occurs. I was <em>lucky</em> to have this test fail,
as it was a legitimate edge case that I hadn't tested against. Needless to say,
there's now a dedicated unit test to out-of-order writing.</p>
<p>While working on this fix, however, I now have enough of a reason to implement
the next version of the transaction log to address a few design issues I've
thought of since writing it originally. The good news is that even if the
transaction log your database has currently is out of order, I plan to have the
upgrade process to the new format fix any ordering issues.</p>
<h2 id="-3">


<a href="#Getting%20Started" name="Getting%20Started">
    Getting Started
    <i class="bi bi-link-45deg hoverable"></i>
</a></h2>
<p>Our <a href="https://bonsaidb.io/">homepage</a> has basic setup instructions and a list of
examples. We have started writing a <a href="https://dev.bonsaidb.io/release/guide/">user's
guide</a>, and we have tried to write <a href="https://docs.rs/bonsaidb/">good
documentation</a>.</p>
<p>We would love to hear from you if you have questions or feedback. We have <a href="https://community.khonsulabs.com/">community Discourse forums</a> and a <a href="https://discord.khonsulabs.com">Discord server</a>, but also welcome anyone to <a href="https://github.com/khonsulabs/bonsaidb/issues/new">open an issue</a> with any questions or feedback.</p>
<p>We dream big with <a href="https://github.com/khonsulabs/bonsaidb">BonsaiDb</a>, and we believe that it can simplify writing and deploying complex, data-driven applications in Rust. We would love <a href="https://github.com/khonsulabs/bonsaidb/labels/good%20first%20issue">additional contributors</a> who have similar passions and ambitions.</p>
<p>Lastly, if you build something with one of our libraries, we would love to hear about it. Nothing makes us happier than hearing people are building things with our crates!</p>

    
    <hr />
    <nav class="pagination" role="navigation">
        
        <a href="&#x2F;blog&#x2F;february-2022-update&#x2F;" class="pagination-previous">&lt; BonsaiDb February update: Supporting and Optimizing BonsaiDb</a>
        

        
        <a href="&#x2F;blog&#x2F;one-year-anniversary&#x2F;" class="pagination-next">A Year of BonsaiDb: A retrospective and looking to the future &gt;</a>
        
    </nav>
    
</div>


    <footer class="footer">
        <div class="content has-text-centered">
            <iframe src="https://github.com/sponsors/ecton/button" title="Sponsor ecton" height="35" width="116"
                style="border: 0;"></iframe>
            <p>
                <strong>BonsaiDb</strong> by <a href="https://khonsulabs.com">Khonsu Labs</a>. The <a
                    href="https://github.com/khonsulabs/bonsaidb">source code</a> is
                dual-licensed with
                <a href="https://github.com/khonsulabs/bonsaidb/blob/main/LICENSE-MIT">MIT</a> and <a
                    href="https://github.com/khonsulabs/bonsaidb/blob/main/LICENSE-APACHE">Apache License 2.0</a>. The
                <a href="https://github.com/khonsulabs/bonsaidb-www/">website content</a>
                is licensed <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY NC SA 4.0</a>.
            </p>
        </div>
    </footer>

    <script src="/site.js"></script>
</body>

</html>